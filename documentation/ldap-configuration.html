---
layout: documentation
title: LDAP Configuration
slug: documentation
side_nav: ldap-configuration
base_url: "/"
---

<div class="container-fluid" id="content">
    <h1>LDAP/Active Directory Authentication</h1>
    
    <p><strong>Version 1.0 for MacPatch v2.6.x</strong></p>

    <p>To enable LDAP/Active Directory Authentication in MacPatch is a very simple task but may require tweaking for your specific environment.</p>

    <p>First, lets start with the basic understanding on how the LDAP authentication works. In MacPatch, authentication against your directory server is done with your directory user name and password. If the user successfully authenticates, the user is granted access. However, by default all directory users in MacPatch are considers user accounts (least privileged) and not admin accounts.</p>

    <h2>Configuration</h2>

    <p>To configure the MacPatch Admin Console to use the ldap authentication a script on the master server needs to run. Run the “DataBaseLDAPSetup.py” script located in “/Library/MacPatch/Server/conf/scripts/Setup” directory. The script will walk you through setting up the database and then the LDAP authentication. You will need to know the following items in order to properly configure the ldap authentication.</p>

    <ul>
        <li>Active Directory/LDAP <strong>Server Hostname</strong></li>
        <li>Active Directory/LDAP <strong>Server Port Number</strong></li>
        <li>Active Directory/LDAP <strong>Use SSL</strong></li>
        <li>Active Directory/LDAP <strong>Search Base</strong></li>
        <li>Active Directory/LDAP <strong>Login Attribute</strong> (default is userPrincipalName)</li>
        <li>Active Directory/LDAP <strong>Login User Name Prefix</strong> (optional)</li>
        <ul>
            <li>This item is used to pre populate a domain for samAccountName auth as an example (e.g. myDomain\).</li>
        </ul>
        <li>Active Directory/LDAP Login User Name Suffix (optional)</li>
        <ul>
            <li>This item is used to pre populate suffix string if using  “userPrincipalName”</li>
        </ul>
    </ul>

    <p>If you choose to use SSL, which is highly recommended then you will need to run the “addRemoteCert.py” script located in “/Library/MacPatch/Server/conf/scripts” directory. This script will download the directory servers certificate and add it to a trusted store only used by the MacPatch server.</p>

    <p><strong>Usage:</strong> sudo addRemoteCert.py –c “dc1.example.com:3269”</p>

    <h2>Advanced Configuration</h2>

    <p>While most LDAP/Active Directory environments have many similar configuration settings each environment has it’s own tweaks. In order to do better filtering on the LDAP queries you might need to modify the ldap filter to achieve what you want.  Once example of this could be to narrow the scope of allowed users by requiring that they belong to a group. To do this you need to edit the “Application.cfc” file located in “/Library/MacPatch /Server/tomcat-mpsite/webapps/ROOT/admin/Application.cfc”. The “filter” string should be located on or around line 299 in the file.</p>

    <p>Default:</p>
    <p>filter="(&(objectClass=*)(#application.settings.ldap.loginAttr#=#arguments.username##application.settings.ldap.loginUsrSufix#))"</p>

    <p>With Group (<strong>In Bold</strong>):</p>
    <p>filter="(&(objectClass=*)(#application.settings.ldap.loginAttr#=#arguments.username##application.settings.ldap.loginUsrSufix#)<strong>(memberOf=CN=MacPatch-Admins,OU=Groups,DC=example,DC=com)</strong>)"</p>

    <p>The LDAP settings may also be edited without the use of the “DataBaseLDAPSetup.py” script. To edit these settings open the “/Library/MacPatch/Server/conf/etc/siteconfig.json” file.</p>

    <table class="table table-bordered table-striped">
        <tr>
            <th>Attribute</th>
            <th>Default Value</th>
            <th>Description</th>
            <th>Notes</th>
        </tr>
        <tr>
            <td>server</td>
            <td>None</td>
            <td>LDAP/AD Server to query</td>
            <td></td>
        </tr>
        <tr>
            <td>searchbase</td>
            <td>None</td>
            <td>Query Search Base</td>
            <td>Another way to filter the search</td>
        </tr>
        <tr>
            <td>port</td>
            <td>None</td>
            <td>LDAP/AD Service Port</td>
            <td>LDAP: 389 or 636<br>AD: 3268 or 3269</td>
        </tr>
        <tr>
            <td>secure</td>
            <td>None</td>
            <td>Use SSL transport</td>
            <td>If using SSL the required value is <strong>CFSSL_BASIC</strong></td>
        </tr>
        <tr>
            <td>loginAttr</td>
            <td>userPrincipalName</td>
            <td>User to verify</td>
            <td></td>
        </tr>
        <tr>
            <td>loginUsrPrefix</td>
            <td>userPrincipalName</td>
            <td>Prefix for logins (e.g. <strong>domain\</strong>username )</td>
            <td>Usually used if using <strong>samAccountName</strong> not required</td>
        </tr>
        <tr>
            <td>loginUsrSufix</td>
            <td>None</td>
            <td></td>
            <td>Usually used when using <strong>userPrincipalName</strong> not required</td>
        </tr>
    </table>

</div>